# abort script on any command that exits with a non zero value
set -ex

XTRABACKUP_VERSION=2.2.10

export PATH=$PATH:/var/vcap/packages/socat/bin
export PATH=$PATH:/var/vcap/packages/libdbi-perl/bin
export PATH=$PATH:/var/vcap/packages/libdbd-mysql-perl/bin
export PATH=$PATH:/var/vcap/packages/autoconf/bin
export PATH=$PATH:/var/vcap/packages/automake/bin
export PATH=$PATH:/var/vcap/packages/libtool/bin
export PATH=$PATH:/var/vcap/packages/mariadb/bin

export PATH=$PATH:${BOSH_INSTALL_TARGET}/bin

# It is easier to install libaio inline here on the same compilation VM
# than to compile it separately and tell xtrabackup where it should look
LIBAIO_VERSION=0.3.110
tar xzf xtrabackup/libaio_${LIBAIO_VERSION}.orig.tar.gz
(
  set -e
  cd libaio-${LIBAIO_VERSION}
  make
  make install
)

tar xzf xtrabackup/percona-xtrabackup-percona-xtrabackup-${XTRABACKUP_VERSION}.tar.gz
(
  set -e
  cd percona-xtrabackup-percona-xtrabackup-${XTRABACKUP_VERSION}

  cmake \
      -DBUILD_CONFIG=xtrabackup_release \
      -DCMAKE_INSTALL_PREFIX=${BOSH_INSTALL_TARGET} \
      -DWITH_MAN_PAGES=OFF
  make -j4
  make install
)

